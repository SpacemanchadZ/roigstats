<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cardinal IG Roanoke â€” Production Board</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c10; --surface: #111318; --surface2: #181c24;
    --border: #1e2230; --border-bright: #2d3348;
    --text: #e8eaf0; --text-dim: #7a8099; --text-muted: #3d4460;
    --green: #22c55e; --green-dim: #14532d; --green-bg: #0a1f12;
    --yellow: #f59e0b; --yellow-dim: #78350f; --yellow-bg: #1f1505;
    --red: #ef4444; --red-dim: #7f1d1d; --red-bg: #1a0808;
    --slate: #64748b; --slate-bg: #0f1420;
    --accent: #C41E3A;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; }
  body { background: var(--bg); color: var(--text); font-family: 'IBM Plex Sans', sans-serif; display: flex; flex-direction: column; }

/* â”€â”€ LOGIN â”€â”€ */
#login-screen { display: flex; align-items: center; justify-content: center; height: 100vh; }
.login-box { background: var(â€“surface); border: 1px solid var(â€“border-bright); border-top: 3px solid var(â€“accent); padding: 36px 32px; width: 340px; }
.login-logo { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
.login-mark { width: 42px; height: 42px; background: var(â€“accent); clip-path: polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%); display: flex; align-items: center; justify-content: center; font-family: â€˜Bebas Neueâ€™, sans-serif; font-size: 11px; color: #fff; letter-spacing: 1px; }
.login-title { font-family: â€˜Bebas Neueâ€™, sans-serif; font-size: 20px; letter-spacing: 0.08em; }
.login-sub { font-size: 10px; color: var(â€“text-dim); letter-spacing: 0.1em; text-transform: uppercase; }
.login-label { display: block; font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(â€“text-dim); margin-bottom: 5px; }
.login-input { width: 100%; background: var(â€“bg); border: 1px solid var(â€“border-bright); color: var(â€“text); padding: 10px 12px; font-family: â€˜IBM Plex Sansâ€™, sans-serif; font-size: 13px; outline: none; margin-bottom: 14px; }
.login-input:focus { border-color: var(â€“accent); }
.login-btn { width: 100%; padding: 11px; background: var(â€“accent); color: #fff; border: none; font-family: â€˜IBM Plex Sansâ€™, sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; margin-top: 4px; }
.login-btn:hover { opacity: 0.88; }
.login-err { color: var(â€“red); font-size: 11px; margin-top: 10px; display: none; text-align: center; }
.view-only-link { text-align: center; margin-top: 14px; }
.view-only-link a { font-size: 11px; color: var(â€“text-dim); cursor: pointer; text-decoration: underline; }

/* â”€â”€ BOARD SCREEN â”€â”€ */
#board-screen { display: none; flex-direction: column; height: 100vh; }

/* â”€â”€ HEADER â”€â”€ */
header { background: var(â€“surface); border-bottom: 2px solid var(â€“accent); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 46px; flex-shrink: 0; }
.header-left { display: flex; align-items: center; gap: 12px; }
.logo-mark { width: 32px; height: 32px; background: var(â€“accent); clip-path: polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%); display: flex; align-items: center; justify-content: center; font-family: â€˜Bebas Neueâ€™, sans-serif; font-size: 9px; color: #fff; letter-spacing: 1px; }
.facility-name { font-family: â€˜Bebas Neueâ€™, sans-serif; font-size: 18px; letter-spacing: 0.1em; }
.facility-sub { font-size: 8px; color: var(â€“text-dim); letter-spacing: 0.15em; text-transform: uppercase; }
.header-right { display: flex; align-items: center; gap: 14px; }
.legend { display: flex; gap: 12px; }
.leg-item { display: flex; align-items: center; gap: 4px; font-size: 9px; color: var(â€“text-dim); text-transform: uppercase; letter-spacing: 0.06em; }
.leg-dot { width: 6px; height: 6px; border-radius: 50%; }
.shift-badge { background: var(â€“surface2); border: 1px solid var(â€“border-bright); padding: 2px 10px; font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(â€“accent); }
#clock { font-family: â€˜IBM Plex Monoâ€™, monospace; font-size: 13px; color: var(â€“text-dim); min-width: 95px; text-align: right; }
.sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(â€“slate); }
.sync-dot.live { background: var(â€“green); animation: pg 2s infinite; }
.sync-dot.saving { background: var(â€“yellow); }
.sync-dot.error { background: var(â€“red); }
.user-badge { font-size: 9px; color: var(â€“text-muted); font-family: â€˜IBM Plex Monoâ€™, monospace; }
.logout-btn { font-size: 10px; color: var(â€“text-muted); cursor: pointer; background: none; border: none; font-family: inherit; }
.logout-btn:hover { color: var(â€“text-dim); }

/* â”€â”€ TOP BAR â”€â”€ */
.top-bar { display: flex; align-items: center; background: var(â€“surface); border-bottom: 1px solid var(â€“border); flex-shrink: 0; height: 36px; }
.stat-chip { display: flex; align-items: center; gap: 7px; padding: 0 16px; border-right: 1px solid var(â€“border); height: 100%; }
.stat-chip .count { font-family: â€˜Bebas Neueâ€™, sans-serif; font-size: 18px; line-height: 1; }
.stat-chip .lbl { font-size: 8px; letter-spacing: 0.1em; text-transform: uppercase; color: var(â€“text-dim); }
.notes-wrap { flex: 1; display: flex; align-items: center; gap: 10px; padding: 0 14px; border-left: 3px solid var(â€“accent); height: 100%; }
.notes-label { font-size: 8px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(â€“accent); white-space: nowrap; }
#shift-notes { background: transparent; border: none; color: var(â€“text-dim); font-family: inherit; font-size: 12px; width: 100%; outline: none; }
#shift-notes::placeholder { color: var(â€“text-muted); }
#shift-notes:disabled { opacity: 0.3; }
.sync-note { font-size: 9px; color: var(â€“text-muted); font-family: â€˜IBM Plex Monoâ€™, monospace; white-space: nowrap; padding: 0 14px; }

/* â”€â”€ SCOREBOARD â”€â”€ */
.board { flex: 1; display: flex; flex-direction: column; padding: 8px 16px 8px; gap: 0; overflow: hidden; justify-content: space-evenly; }

.section { display: flex; flex-direction: column; gap: 2px; }

.section-label { font-family: â€˜Bebas Neueâ€™, sans-serif; font-size: 9px; letter-spacing: 0.28em; color: var(â€“text-muted); text-transform: uppercase; display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
.section-label::before { content: â€˜â€™; width: 3px; height: 9px; background: var(â€“accent); flex-shrink: 0; }
.section-label::after { content: â€˜â€™; flex: 1; height: 1px; background: var(â€“border); }

/* Machine row */
.eq-row { display: flex; align-items: center; background: var(â€“surface); border: 1px solid var(â€“border); border-left: 4px solid transparent; padding: 0 14px; height: 38px; transition: background 0.15s; position: relative; }
.eq-row.clickable { cursor: pointer; }
.eq-row.clickable:hover { background: var(â€“surface2); }

.eq-row.running { border-left-color: var(â€“green); background: linear-gradient(90deg, #0a1f1280 0%, var(â€“surface) 25%); }
.eq-row.pm      { border-left-color: var(â€“yellow); background: linear-gradient(90deg, #1f150580 0%, var(â€“surface) 25%); }
.eq-row.down    { border-left-color: var(â€“red);    background: linear-gradient(90deg, #1a080880 0%, var(â€“surface) 25%); }
.eq-row.idle    { border-left-color: var(â€“slate);  background: var(â€“surface); }

.row-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; margin-right: 12px; }
.running .row-dot { background: var(â€“green); animation: pg 2s infinite; }
.pm      .row-dot { background: var(â€“yellow); }
.down    .row-dot { background: var(â€“red); animation: pr 1s infinite; }
.idle    .row-dot { background: #2d3348; }

.row-name { font-family: â€˜Bebas Neueâ€™, sans-serif; font-size: 17px; letter-spacing: 0.05em; flex: 1; color: var(â€“text); }

.row-sched { display: flex; gap: 3px; margin-right: 14px; }
.sc { font-size: 8px; font-family: â€˜IBM Plex Monoâ€™, monospace; padding: 1px 5px; border: 1px solid var(â€“border); color: var(â€“text-muted); }
.sc.on { border-color: var(â€“green-dim); color: var(â€“green); background: #0a1f1240; }

.row-note { font-size: 10px; color: var(â€“text-dim); font-style: italic; margin-right: 14px; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }

.row-status { font-family: â€˜IBM Plex Monoâ€™, monospace; font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; padding: 3px 12px; flex-shrink: 0; min-width: 96px; text-align: center; }
.running .row-status { background: var(â€“green-dim); color: var(â€“green); }
.pm      .row-status { background: var(â€“yellow-dim); color: var(â€“yellow); }
.down    .row-status { background: var(â€“red-dim); color: var(â€“red); }
.idle    .row-status { background: #1a1e2a; color: var(â€“slate); }

@keyframes pg { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.3;transform:scale(1.7)} }
@keyframes pr { 0%,100%{opacity:1} 50%{opacity:.1} }

/* â”€â”€ MODAL â”€â”€ */
.overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:200; align-items:center; justify-content:center; }
.overlay.open { display:flex; }
.modal { background:var(â€“surface); border:1px solid var(â€“border-bright); border-top:3px solid var(â€“accent); width:400px; max-width:95vw; padding:24px; }
.modal-eq-name { font-family:â€˜Bebas Neueâ€™,sans-serif; font-size:24px; letter-spacing:0.06em; margin-bottom:2px; }
.modal-area { font-size:10px; color:var(â€“text-dim); letter-spacing:0.12em; text-transform:uppercase; }
.sched-hint { font-size:10px; color:var(â€“text-muted); font-family:â€˜IBM Plex Monoâ€™,monospace; margin-top:4px; margin-bottom:14px; padding-bottom:12px; border-bottom:1px solid var(â€“border); }
.form-row { margin-bottom:12px; }
.form-label { display:block; font-size:10px; font-weight:700; letter-spacing:0.12em; text-transform:uppercase; color:var(â€“text-dim); margin-bottom:5px; }
.status-btns { display:grid; grid-template-columns:1fr 1fr; gap:5px; }
.status-btn { padding:9px 8px; border:2px solid var(â€“border); background:var(â€“bg); color:var(â€“text-dim); cursor:pointer; font-family:inherit; font-size:11px; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; transition:all 0.1s; }
.status-btn:hover { border-color:var(â€“border-bright); color:var(â€“text); }
.status-btn.sel-running { border-color:var(â€“green); background:var(â€“green-bg); color:var(â€“green); }
.status-btn.sel-pm { border-color:var(â€“yellow); background:var(â€“yellow-bg); color:var(â€“yellow); }
.status-btn.sel-down { border-color:var(â€“red); background:var(â€“red-bg); color:var(â€“red); }
.status-btn.sel-idle { border-color:var(â€“slate); background:var(â€“slate-bg); color:var(â€“slate); }
.form-input { width:100%; background:var(â€“bg); border:1px solid var(â€“border-bright); color:var(â€“text); padding:8px 10px; font-family:inherit; font-size:13px; outline:none; }
.form-input:focus { border-color:var(â€“accent); }
.form-input::placeholder { color:var(â€“text-muted); }
.modal-actions { display:flex; gap:6px; margin-top:14px; }
.btn { flex:1; padding:10px; font-family:inherit; font-size:11px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; border:none; }
.btn-save { background:var(â€“accent); color:#fff; }
.btn-reset { background:var(â€“surface2); color:var(â€“text-dim); border:1px solid var(â€“border-bright); flex:0.7; font-size:9px; }
.btn-cancel { background:var(â€“surface2); color:var(â€“text-dim); border:1px solid var(â€“border-bright); flex:0.6; }

/* â”€â”€ TOAST â”€â”€ */
#toast { position:fixed; bottom:18px; right:18px; background:var(â€“surface2); border:1px solid var(â€“border-bright); border-left:3px solid var(â€“green); padding:7px 13px; font-size:11px; color:var(â€“text); opacity:0; transition:opacity 0.3s; pointer-events:none; z-index:999; font-family:â€˜IBM Plex Monoâ€™,monospace; }
#toast.show { opacity:1; }
#toast.err { border-left-color:var(â€“red); }
#setup-banner { background:var(â€“red-bg); border-bottom:1px solid var(â€“red-dim); padding:5px 18px; font-size:11px; color:var(â€“red); display:none; flex-shrink:0; }
</style>

</head>
<body>

<!-- LOGIN -->

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-mark">ROIG</div>
      <div><div class="login-title">Cardinal IG Roanoke</div><div class="login-sub">Production Board</div></div>
    </div>
    <label class="login-label">Username</label>
    <input class="login-input" id="login-user" type="text" placeholder="username" autocomplete="username">
    <label class="login-label">Password</label>
    <input class="login-input" id="login-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-err" id="login-err">Invalid username or password</div>
    <div class="view-only-link"><a onclick="enterViewOnly()">View only (no login)</a></div>
  </div>
</div>

<!-- BOARD -->

<div id="board-screen">
  <div id="setup-banner">âš  Database not connected â€” run SQL setup in Supabase.</div>

  <header>
    <div class="header-left">
      <div class="logo-mark">ROIG</div>
      <div><div class="facility-name">Cardinal IG Roanoke</div><div class="facility-sub">Production Status Board</div></div>
    </div>
    <div class="header-right">
      <div class="legend">
        <div class="leg-item"><div class="leg-dot" style="background:var(--green)"></div>Running</div>
        <div class="leg-item"><div class="leg-dot" style="background:var(--yellow)"></div>PM / Sched</div>
        <div class="leg-item"><div class="leg-dot" style="background:var(--red)"></div>Down</div>
        <div class="leg-item"><div class="leg-dot" style="background:var(--slate)"></div>Idle</div>
      </div>
      <div class="sync-dot" id="sync-dot"></div>
      <div class="shift-badge" id="shift-label">â€”</div>
      <div id="clock">--:--:--</div>
      <span class="user-badge" id="user-badge"></span>
      <button class="logout-btn" id="logout-btn" onclick="doLogout()" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="top-bar">
    <div class="stat-chip"><span class="count" id="cnt-running" style="color:var(--green)">0</span><span class="lbl">Running</span></div>
    <div class="stat-chip"><span class="count" id="cnt-pm"      style="color:var(--yellow)">0</span><span class="lbl">PM/Sched</span></div>
    <div class="stat-chip"><span class="count" id="cnt-down"    style="color:var(--red)">0</span><span class="lbl">Down</span></div>
    <div class="stat-chip"><span class="count" id="cnt-idle"    style="color:var(--slate)">0</span><span class="lbl">Idle</span></div>
    <div class="notes-wrap">
      <span class="notes-label">Shift Notes</span>
      <input id="shift-notes" type="text" placeholder="Enter handoff notes for next shift..." disabled>
    </div>
    <div class="sync-note" id="last-sync-note">Connecting...</div>
  </div>

  <div class="board" id="board"></div>
</div>

<!-- MODAL -->

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-eq-name" id="modal-name">â€”</div>
    <div class="modal-area" id="modal-area">â€”</div>
    <div class="sched-hint" id="modal-sched-hint"></div>
    <div class="form-row">
      <div class="form-label">Status</div>
      <div class="status-btns">
        <button class="status-btn" id="btn-running" onclick="selectStatus('running')">ðŸŸ¢ Running</button>
        <button class="status-btn" id="btn-pm"      onclick="selectStatus('pm')">ðŸŸ¡ PM / Sched Down</button>
        <button class="status-btn" id="btn-down"    onclick="selectStatus('down')">ðŸ”´ Down</button>
        <button class="status-btn" id="btn-idle"    onclick="selectStatus('idle')">âš« Idle / Standby</button>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label" for="modal-note">Note / WO# (optional)</label>
      <input class="form-input" id="modal-note" type="text" placeholder="e.g. WO-1234, bearing failure...">
    </div>
    <div class="modal-actions">
      <button class="btn btn-save"   onclick="saveStatus()">Save</button>
      <button class="btn btn-reset"  onclick="resetToSchedule()">â†º Schedule</button>
      <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
const SUPABASE_URL = 'https://zqcxfbalufpkqoevazbe.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxY3hmYmFsdWZwa3FvZXZhemJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5Nzk1MDIsImV4cCI6MjA4NzU1NTUwMn0.LTKPUq1jt62U4q4UIHdbu8hVKbkMbFcPNHdXtm4c0eQ';
const API = `${SUPABASE_URL}/rest/v1`;
const hdrs = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' };

const sections = [
  { label: 'IG Lines', rows: [
    { id:'IG1',  name:'IG Line 1',       area:'IG Assembly',         schedule:[1,2,3] },
    { id:'IG2',  name:'IG Line 2',       area:'IG Assembly',         schedule:[]      },
    { id:'IG3',  name:'IG Line 3',       area:'IG Assembly',         schedule:[1,3]   },
    { id:'IG4',  name:'IG Line 4',       area:'IG Assembly',         schedule:[2]     },
  ]},
  { label: 'Cutting', rows: [
    { id:'CT1',  name:'Cutting Table 1', area:'Cutting',             schedule:[1,2,3] },
    { id:'CT2',  name:'Cutting Table 2', area:'Cutting',             schedule:[1,2,3] },
    { id:'LAMI', name:'Lami Table',      area:'Cutting',             schedule:[1,2,3] },
  ]},
  { label: 'Tempering', rows: [
    { id:'FURN', name:'Furnace',         area:'Tempering',           schedule:[1,2,3] },
    { id:'CT3',  name:'Cutting Table 3', area:'Tempering',           schedule:[1,2,3] },
  ]},
  { label: 'Mezzanine', rows: [
    { id:'MBEND',name:'Mezz Bender',     area:'Spacer Fabrication',  schedule:[1,2,3] },
    { id:'MMUT', name:'Mezz Muntin',     area:'Muntin Fabrication',  schedule:[1,2,3] },
    { id:'MEXT', name:'Mezz Extruder',   area:'Extrusion',           schedule:[1,2,3] },
    { id:'MFILL',name:'Mezz Fill Room',  area:'Sieve Fill',          schedule:[1,2,3] },
  ]},
];

const equipment = {};
sections.forEach(s => s.rows.forEach(e => equipment[e.id] = e));

let state = {}, isAdmin = false, currentUser = '';

function shiftInfo() {
  const now = new Date(), d = now.getDay(), h = now.getHours();
  return { shift: h>=7&&h<15?1:h>=15&&h<23?2:3, weekday: d>=1&&d<=5 };
}
function scheduledStatus(id) {
  const { shift, weekday } = shiftInfo();
  if (!weekday) return 'idle';
  return equipment[id].schedule.includes(shift) ? 'running' : 'idle';
}
function shiftName(h) {
  return h>=7&&h<15 ? '1st Shift (7aâ€“3p)' : h>=15&&h<23 ? '2nd Shift (3pâ€“11p)' : '3rd Shift (11pâ€“7a)';
}

// â”€â”€ AUTH â”€â”€
async function doLogin() {
  const user = document.getElementById('login-user').value.trim();
  const pass = document.getElementById('login-pass').value;
  if (!user||!pass) return;
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pass));
  const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  try {
    const res = await fetch(`${API}/board_admins?username=eq.${encodeURIComponent(user)}&password_hash=eq.${hex}&select=username`, { headers: hdrs });
    const data = await res.json();
    if (data?.length > 0) { isAdmin=true; currentUser=user; enterBoard(); }
    else showLoginErr('Invalid username or password');
  } catch(e) { showLoginErr('Connection error â€” check Supabase'); }
}
function showLoginErr(msg) { const el=document.getElementById('login-err'); el.textContent=msg; el.style.display='block'; }
function enterViewOnly() { isAdmin=false; currentUser='viewer'; enterBoard(); }
function enterBoard() {
  document.getElementById('login-screen').style.display='none';
  document.getElementById('board-screen').style.display='flex';
  document.getElementById('user-badge').textContent = isAdmin?`ðŸ‘¤ ${currentUser}`:'ðŸ‘ View Only';
  document.getElementById('logout-btn').style.display = isAdmin?'':'none';
  if (isAdmin) document.getElementById('shift-notes').disabled=false;
  initState(); renderBoard(); loadFromSupabase(); poll(); loadNotes();
}
function doLogout() {
  isAdmin=false; currentUser='';
  document.getElementById('board-screen').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('login-pass').value='';
  document.getElementById('login-err').style.display='none';
}

// â”€â”€ STATE â”€â”€
function initState() {
  Object.keys(equipment).forEach(id => {
    state[id] = { status: scheduledStatus(id), note:'', manual:false, updated_by:'', updated_at:null };
  });
}

// â”€â”€ RENDER â”€â”€
const pillLabel = { running:'Running', pm:'PM / Sched', down:'DOWN', idle:'Idle' };

function renderBoard() {
  const board = document.getElementById('board');
  board.innerHTML = '';
  const { shift } = shiftInfo();
  sections.forEach(sec => {
    const wrap = document.createElement('div');
    wrap.className = 'section';
    const lbl = document.createElement('div');
    lbl.className = 'section-label';
    lbl.textContent = sec.label;
    wrap.appendChild(lbl);
    sec.rows.forEach(eq => {
      wrap.appendChild(buildRow(eq, state[eq.id] || {status:'idle',note:''}, shift));
    });
    board.appendChild(wrap);
  });
}

function buildRow(eq, s, shift) {
  const row = document.createElement('div');
  row.className = `eq-row ${s.status}${isAdmin?' clickable':''}`;
  row.id = 'row-' + eq.id;
  if (isAdmin) row.onclick = () => openModal(eq.id);
  const chips = [1,2,3].map(n=>`<span class="sc${eq.schedule.includes(n)?' on':''}">${n===1?'1ST':n===2?'2ND':'3RD'}</span>`).join('');
  row.innerHTML = `
    <div class="row-dot"></div>
    <div class="row-name">${eq.name}</div>
    
    <div class="row-sched">${chips}</div>
    <div class="row-note">${s.note||''}</div>
    <div class="row-status">${pillLabel[s.status]}</div>
  `;
  return row;
}

function refreshRow(id) {
  const old = document.getElementById('row-' + id);
  if (!old) return;
  const eq = equipment[id], s = state[id];
  const { shift } = shiftInfo();
  const newRow = buildRow(eq, s, shift);
  old.replaceWith(newRow);
}

function updateCounts() {
  const vals = Object.entries(state).filter(([k])=>k!=='__shift_notes__').map(([,v])=>v);
  ['running','pm','down','idle'].forEach(st => {
    const el = document.getElementById('cnt-'+st);
    if (el) el.textContent = vals.filter(x=>x.status===st).length;
  });
}

// â”€â”€ SUPABASE â”€â”€
async function loadFromSupabase() {
  setSyncDot('saving');
  try {
    const res = await fetch(`${API}/board_status?select=id,status,note,manual,updated_at,updated_by`, { headers: hdrs });
    if (!res.ok) throw new Error();
    const rows = await res.json();
    rows.forEach(row => {
      if (state[row.id]!==undefined)
        state[row.id] = { status:row.status, note:row.note||'', manual:row.manual, updated_by:row.updated_by||'', updated_at:row.updated_at };
    });
    renderBoard(); updateCounts(); setSyncDot('live');
    document.getElementById('setup-banner').style.display='none';
    setSync();
  } catch(e) {
    setSyncDot('error');
    document.getElementById('setup-banner').style.display='block';
    document.getElementById('last-sync-note').textContent='âš  Not connected';
  }
}

async function upsert(id, status, note, manual) {
  setSyncDot('saving');
  try {
    const res = await fetch(`${API}/board_status`, {
      method:'POST', headers:{...hdrs,'Prefer':'resolution=merge-duplicates,return=minimal'},
      body: JSON.stringify({ id, status, note, manual, updated_at:new Date().toISOString(), updated_by:currentUser })
    });
    if (!res.ok) throw new Error();
    setSyncDot('live'); setSync();
    showToast(`${equipment[id].name} â†’ ${status.toUpperCase()}`);
  } catch(e) { setSyncDot('error'); showToast('Save failed',true); }
}

async function upsertNotes(val) {
  try {
    await fetch(`${API}/board_status`, {
      method:'POST', headers:{...hdrs,'Prefer':'resolution=merge-duplicates,return=minimal'},
      body: JSON.stringify({ id:'__shift_notes__', status:'idle', note:val, manual:false, updated_by:currentUser, updated_at:new Date().toISOString() })
    });
  } catch(e){}
}

async function loadNotes() {
  try {
    const res = await fetch(`${API}/board_status?id=eq.__shift_notes__&select=note`, { headers: hdrs });
    const data = await res.json();
    if (data?.[0]) document.getElementById('shift-notes').value = data[0].note||'';
  } catch(e){}
}

function poll() {
  setInterval(async () => {
    if (document.hidden) return;
    try {
      const res = await fetch(`${API}/board_status?select=id,status,note,manual,updated_at,updated_by`, { headers: hdrs });
      if (!res.ok) return;
      const rows = await res.json();
      let changed = false;
      rows.forEach(row => {
        if (row.id==='__shift_notes__') {
          const ni=document.getElementById('shift-notes');
          if (ni&&document.activeElement!==ni) ni.value=row.note||'';
          return;
        }
        if (state[row.id]&&state[row.id].updated_at!==row.updated_at) {
          state[row.id]={ status:row.status, note:row.note||'', manual:row.manual, updated_by:row.updated_by, updated_at:row.updated_at };
          refreshRow(row.id); changed=true;
        }
      });
      if (changed) updateCounts();
      setSyncDot('live'); setSync();
    } catch(e){}
  }, 5000);
}

// â”€â”€ MODAL â”€â”€
let activeId=null, selStatus=null;
function openModal(id) {
  if (!isAdmin) return;
  activeId=id;
  const eq=equipment[id], s=state[id];
  document.getElementById('modal-name').textContent=eq.name;
  document.getElementById('modal-area').textContent=eq.area;
  document.getElementById('modal-note').value=s.note||'';
  const sl={1:'1st (7aâ€“3p)',2:'2nd (3pâ€“11p)',3:'3rd (11pâ€“7a)'};
  const sched=eq.schedule.length?'Scheduled: '+eq.schedule.map(n=>sl[n]).join(', '):'Not scheduled â€” Idle by default';
  const man=s.manual?` <span style="color:var(--yellow)">[Override: ${s.updated_by||'?'}]</span>`:'';
  document.getElementById('modal-sched-hint').innerHTML=sched+man;
  selectStatus(s.status);
  document.getElementById('overlay').classList.add('open');
  setTimeout(()=>document.getElementById('modal-note').focus(),80);
}
function selectStatus(st) {
  selStatus=st;
  ['running','pm','down','idle'].forEach(s=>{
    document.getElementById('btn-'+s).className='status-btn'+(s===st?' sel-'+s:'');
  });
}
function closeModal() { document.getElementById('overlay').classList.remove('open'); activeId=null; selStatus=null; }
function saveStatus() {
  if (!activeId||!selStatus) return;
  const note=document.getElementById('modal-note').value.trim();
  state[activeId]={ status:selStatus, note, manual:true, updated_by:currentUser, updated_at:new Date().toISOString() };
  refreshRow(activeId); updateCounts();
  upsert(activeId, selStatus, note, true);
  closeModal();
}
function resetToSchedule() {
  if (!activeId) return;
  const st=scheduledStatus(activeId);
  state[activeId]={ status:st, note:'', manual:false, updated_by:currentUser, updated_at:new Date().toISOString() };
  refreshRow(activeId); updateCounts();
  upsert(activeId, st, '', false);
  closeModal();
}
document.getElementById('overlay').addEventListener('click',e=>{ if(e.target===document.getElementById('overlay')) closeModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); if(e.key==='Enter'&&activeId) saveStatus(); });
document.getElementById('login-pass').addEventListener('keydown',e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('login-user').addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('login-pass').focus(); });

// Shift notes debounce
let notesT=null;
document.getElementById('shift-notes').addEventListener('input',e=>{ clearTimeout(notesT); notesT=setTimeout(()=>upsertNotes(e.target.value),1000); });

// â”€â”€ CLOCK â”€â”€
function tick() {
  const now=new Date(), p=n=>String(n).padStart(2,'0');
  let h=now.getHours(); const ap=h>=12?'PM':'AM'; h=h%12||12;
  document.getElementById('clock').textContent=`${h}:${p(now.getMinutes())}:${p(now.getSeconds())} ${ap}`;
  document.getElementById('shift-label').textContent=shiftName(now.getHours());
}
setInterval(tick,1000); tick();

function setSyncDot(s) { document.getElementById('sync-dot').className='sync-dot '+s; }
function setSync() {
  const now=new Date(), p=n=>String(n).padStart(2,'0');
  document.getElementById('last-sync-note').textContent=`Live Â· ${p(now.getHours())}:${p(now.getMinutes())}:${p(now.getSeconds())}`;
}

let toastT=null;
function showToast(msg,err=false) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show'+(err?' err':'');
  clearTimeout(toastT); toastT=setTimeout(()=>t.className='',3000);
}
</script>

</body>
</html>
